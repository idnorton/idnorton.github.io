<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
<generator uri="http://jekyllrb.com" version="3.8.5">Jekyll</generator>
<link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" />
<link href="http://localhost:4000/" rel="alternate" type="text/html" />
<updated>2020-04-22T20:31:03+00:00</updated>
<id>http://localhost:4000/</id>
<subtitle>Website and blog</subtitle>
<entry>
<title>SSH ProxyCommand for subnets</title>
<link href="http://localhost:4000/2020/03/28/SSH-ProxyCommand-for-subnets.html" rel="alternate" type="text/html" title="SSH ProxyCommand for subnets" />
<published>2020-03-28T00:00:00+00:00</published>
<updated>2020-03-28T00:00:00+00:00</updated>
<id>http://localhost:4000/2020/03/28/SSH-ProxyCommand-for-subnets</id>
<content type="html" xml:base="http://localhost:4000/2020/03/28/SSH-ProxyCommand-for-subnets.html">&lt;h1 id=&quot;ssh-proxycommand-for-subnets&quot;&gt;SSH ProxyCommand for subnets&lt;/h1&gt;

&lt;p&gt;It’s common in modern cloud environments to prevent ssh access to hosts
within the environment and only allow access to a single well maintained
bastion host with suitable protections against attack.&lt;/p&gt;

&lt;p&gt;If you have multiple environments with non overlapping IP address
assignments then it would be neat to be able to configure the ssh client
to be able to use a different bastion host based on a CIDR match.&lt;/p&gt;

&lt;p&gt;Let’s take some examples:&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;AWS Account&lt;/th&gt;
      &lt;th&gt;Bastion host&lt;/th&gt;
      &lt;th&gt;CIDR&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;Account A&lt;/td&gt;
      &lt;td&gt;bastion.account-a.example.com&lt;/td&gt;
      &lt;td&gt;10.0.0.0/16&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Account B&lt;/td&gt;
      &lt;td&gt;bastion.account-b.example.com&lt;/td&gt;
      &lt;td&gt;10.1.0.0/16&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Account C&lt;/td&gt;
      &lt;td&gt;bastion.account-c.example.com&lt;/td&gt;
      &lt;td&gt;10.2.0.0/24&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Account D&lt;/td&gt;
      &lt;td&gt;bastion.account-d.example.com&lt;/td&gt;
      &lt;td&gt;10.3.0.0/25&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Account E&lt;/td&gt;
      &lt;td&gt;bastion.account-e.example.com&lt;/td&gt;
      &lt;td&gt;10.3.0.128/25&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;In the table above, we can use a traditional string match for the first
three:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Match 10.0.*
    ProxyCommand ssh -q bastion.account-a.example.com -W %h:%p

Match 10.1.*
    ProxyCommand ssh -q bastion.account-b.example.com -W %h:%p

Match 10.2.*
    ProxyCommand ssh -q bastion.account-c.example.com -W %h:%p
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However that doesn’t work for the last two. So how do we do this?
The answer is that we cannot achieve this with the a standard
configuration options.&lt;/p&gt;

&lt;p&gt;This is something that’s had questions online &lt;a href=&quot;https://serverfault.com/questions/803902/&quot;&gt;https://serverfault.com/questions/803902/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There’s even a feature request &lt;a href=&quot;http://bugzilla.mindrot.org/show_bug.cgi?id=1169&quot;&gt;http://bugzilla.mindrot.org/show_bug.cgi?id=1169&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There isn’t currently a way to do this, however there is a neat feature in
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Match exec&lt;/code&gt; which allows us to run a command and use the exit codes:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;The exec keyword executes the specified command under the user's shell.  If the
command returns a zero exit status then the condition is considered true.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Docs at &lt;a href=&quot;https://linux.die.net/man/5/ssh_config&quot;&gt;https://linux.die.net/man/5/ssh_config&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Having written some GoLang to do the network matching, we can now use this syntax:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  Match exec &quot;~/bin/ssh-test-network --cidr=10.3.0.0/25 --host=%n
    ProxyCommand ssh -q bastion.account-d.example.com -W %h:%p

  Match exec &quot;~/bin/ssh-test-network --cidr=10.3.0.128/25 --host=%n
    ProxyCommand ssh -q bastion.account-e.example.com -W %h:%p
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here’s the command line options for the tool:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ ./ssh-test-network --help
Usage of ./ssh-test-network:

  -cidr string
        CIDR network to test against
  -debug
        Enable debugging
  -host string
        Hostname to test

Use this command to route subnet ssh via a jumphost in your ssh config:

  Match exec &quot;~/bin/ssh-test-network --cidr=10.0.0.0/8 --host=%n
    ProxyCommand ssh -q jumpbox.example.com -W %h:%p
    ForwardAgent yes
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;files&quot;&gt;Files&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;/assets/2020-03-28/ssh-test-network&quot;&gt;ssh-test-network (binary)&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/assets/2020-03-28/ssh-test-network.go&quot;&gt;ssh-test-network.go (source)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
<summary>SSH ProxyCommand for subnets</summary>
</entry>
<entry>
<title>Presence sensors again!</title>
<link href="http://localhost:4000/2017/02/28/Presence-sensors-again.html" rel="alternate" type="text/html" title="Presence sensors again!" />
<published>2017-02-28T00:00:00+00:00</published>
<updated>2017-02-28T00:00:00+00:00</updated>
<id>http://localhost:4000/2017/02/28/Presence-sensors-again</id>
<content type="html" xml:base="http://localhost:4000/2017/02/28/Presence-sensors-again.html">&lt;h1 id=&quot;presence-sensors-again&quot;&gt;Presence sensors again!&lt;/h1&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2017-02-28/pir3-2-473x372.png&quot; alt=&quot;Component side of PIR PCB marked up 24v&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In my previous two posts I’ve talked about hacking cheap presence sensors to work on 24v DC rather than mains.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://lamm.space/2015/04/14/is-there-anybody-there-click-once-for-yes/&quot;&gt;Is there anybody there? Click once for yes!&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://lamm.space/2016/09/10/presence-sensors-revisited/&quot;&gt;Presence sensors revisited&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;As does happen with these things, we’ve ended up with another different style of sensor from the same supplier!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2017-02-28/pir3-pcb-273x300.png&quot; alt=&quot;Solder side of PIR PCB with overlaid components in red&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The design of this one is actually more complicated than we’ve seen previously making use of zenner diodes to drop the +24v DC to 5v for the front panel PCB.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2017-02-28/pir3-2-264x300.png&quot; alt=&quot;Component side of PIR PCB marked up 24v&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Thanks once again to Malc who eventually gave up trying to make this design work and posted me three up to look at, I shall enjoy the beer on you mate&lt;/p&gt;

&lt;p&gt;Hack on!&lt;/p&gt;

&lt;p&gt;Ian&lt;/p&gt;
</content>
<summary>Presence sensors again!</summary>
</entry>
<entry>
<title>Presence sensors revisited</title>
<link href="http://localhost:4000/2016/09/10/Presence-sensors-revisited.html" rel="alternate" type="text/html" title="Presence sensors revisited" />
<published>2016-09-10T00:00:00+00:00</published>
<updated>2016-09-10T00:00:00+00:00</updated>
<id>http://localhost:4000/2016/09/10/Presence-sensors-revisited</id>
<content type="html" xml:base="http://localhost:4000/2016/09/10/Presence-sensors-revisited.html">&lt;h1 id=&quot;presence-sensors-revisited&quot;&gt;Presence sensors revisited&lt;/h1&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2016-09-10/2016-09-10-17.49.45-1038x576.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In my previous post I talked about 24v presence sensors for Loxone home automation:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2016-09-10/Previous_post_tweet.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Shout out to Malc Crook (&lt;a href=&quot;https://hackaday.io/mal8837&amp;quot;&amp;gt;https://hackaday.io/mal8837&quot;&gt;https://hackaday.io/mal8837”&amp;gt;https://hackaday.io/mal8837&lt;/a&gt;) and Adam (&lt;a href=&quot;&amp;gt;https://hackaday.io/Bobbsta10&quot;&gt;https://hackaday.io/Bobbsta10&lt;/a&gt;) who both contacted me to say that the PIR linked to in the original post is no longer the one you get when you order the same item from the same seller :-)&lt;/p&gt;

&lt;p&gt;Fear not, for I have hacked the new one this evening and it’s pretty straight forward :-)&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2016-09-10/2016-09-10-17.49.04-300x139.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Well that mostly looks similar…&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2016-09-10/2016-09-10-17.49.45-300x169.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Still looks similar…&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2016-09-10/2016-09-10-17.51.32-300x169.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Well that’s different. The two boards are fixed together and the front board has to come away from the plastic shafts for altering the time and lux level&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2016-09-10/2016-09-10-17.53.30-169x300.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Those are really annoying to get back in but I’ll come back to that.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2016-09-10/2016-09-10-17.54.47-300x169.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Different AC supply board this time around. Let’s take a look see what’s going on..&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2016-09-10/PIR-AC-board-layout-284x300.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;So capacative dropper is driving an actual bridge rectifier this time rather than four discrete diodes. Seems like there’s a lot here we don’t need….&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2016-09-10/2016-09-10-18.24.24-300x169.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I always end up with spare bits when I take things apart….&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2016-09-10/2016-09-10-18.48.00-300x169.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Right, so now we look like:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2016-09-10/2016-09-10-18.33.06-169x300.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;So having removed all but the diodes for protection and the capacitor for smoothing the supply, we’re left with +24v going in and a working automation PIR! I put the front board in place without screwing it in and put the spacers on the back board as it came but without the screws. We’re no longer dealing with mains voltage and the spacers keep everything sensibly… well… spaced… Best update the labelling…&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2016-09-10/2016-09-10-18.47.18-169x300.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;That’s a bit neater than the previous scribblings with a sharpie… :-D&lt;/p&gt;

&lt;p&gt;I’m hoping that step by step pictures and the diagram will make it clear how this change works. The PIR module is 24v all along, all we did was remove the AC components and drive it directly.&lt;/p&gt;

&lt;p&gt;There doesn’t seem to be an LED on this model. The relay is triggered by dropping the signal line from the front board to 0v. It floats at +24 otherwise so technically we could lose the relay completely and drive that back to an input. I’ve not tested that so your mileage may vary.&lt;/p&gt;

&lt;p&gt;Hopefully that update will be useful to people!&lt;/p&gt;

&lt;p&gt;Keep hacking, Ian.&lt;/p&gt;
</content>
<summary>Presence sensors revisited</summary>
</entry>
<entry>
<title>Is there anybody there? Click once for yes!</title>
<link href="http://localhost:4000/2015/04/14/PIR-Sensors.html" rel="alternate" type="text/html" title="Is there anybody there? Click once for yes!" />
<published>2015-04-14T00:00:00+00:00</published>
<updated>2015-04-14T00:00:00+00:00</updated>
<id>http://localhost:4000/2015/04/14/PIR-Sensors</id>
<content type="html" xml:base="http://localhost:4000/2015/04/14/PIR-Sensors.html">&lt;h1 id=&quot;is-there-anybody-there-click-once-for-yes&quot;&gt;Is there anybody there? Click once for yes!&lt;/h1&gt;

&lt;p&gt;So following on from my &lt;a href=&quot;https://hackaday.io/project/4857-commercial-home-automation/log/16130-switches-are-simple-right&quot;&gt;previous post about switches&lt;/a&gt;, let’s talk about Passive Infra Red (PIR) sensors.&lt;/p&gt;

&lt;p&gt;Previously posted on &lt;a href=&quot;https://lamm.space/2015/04/14/is-there-anybody-there-click-once-for-yes/&quot;&gt;LAMM Space&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;loxone-presence-sensor&quot;&gt;Loxone Presence Sensor&lt;/h2&gt;

&lt;p&gt;Cost: OMG HOW MUCH?!&lt;br /&gt;
Summary: No way in hell I’m buying one at that price&lt;br /&gt;
Supplier: Loxone&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2015-04-14/loxone-presence-sensor_0-300x196.png&quot; alt=&quot;Round surface mount PIR from Loxone&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Wow, the price of this is staggering. It’s got a light level sensor and a PIR in it. I’m not going to buy one, but I’m including it here without much comment.
Manufacturers site – &lt;a href=&quot;http://shop.loxone.com/enuk/presence-sensor.html&quot;&gt;http://shop.loxone.com/enuk/presence-sensor.html&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;generic-presence-sensor&quot;&gt;Generic presence sensor&lt;/h2&gt;

&lt;p&gt;Cost: Low (£10)&lt;br /&gt;
Summary: Not quite what I’m after, but I can hack this.&lt;br /&gt;
Supplier: Low Energy Supermarket Ebay shop&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2015-04-14/generic-pir-300x212.jpg&quot; alt=&quot;Side image of PIR&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I purchased this with the thought that I would place them in some rooms outside of the automation system like the toilet and possibly the kitchen. I ran it in the kitchen for a while until it finally started to annoy me. There’s an adjustable timer and light level sensor which means that once the light drops below a certain level the PIR will activate the light until no presence is detected and the timer runs down. It’s 240v mains, which isn’t great for working with, so having gotten annoyed with it and removed it (Claire nearly cut herself after the lights in the kitchen went out) I took it apart for a looksee.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2015-04-14/generic-pir-insides01-300x169.jpg&quot; alt=&quot;PIR initial disassembly&quot; /&gt;&lt;/p&gt;

&lt;p&gt;So what’s the black tube? It’s a fuse, that’s a good thing. Otherwise not much of interest.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2015-04-14/generic-pir-insides02-291x300.jpg&quot; alt=&quot;PIR PCB before modification&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Oh hello! That’s a 24v relay. That means that we’re looking at a 24v DC supply. &lt;em&gt;grin&lt;/em&gt; The Loxone kit is 24v DC, which I don’t think I’ve mentioned so far. The two circuit boards are a mains power supply and the combined PIR and logic board with the two variable resistors on. Removing or modifying the back board &lt;em&gt;should&lt;/em&gt; give us a board that we can power with 24v and will trigger a 24v line when activity and suitable light level are detected. We don’t actually care about the light level or the timer so we can turn both right down. Now we have something we can connect directly to a Loxone digital input and feed into a lighting controller block for a fraction of the cost of the official presence sensor. This I like :)&lt;/p&gt;

&lt;p&gt;Purchased from Low Energy Supermarket Ebay Shop – &lt;a href=&quot;http://www.ebay.co.uk/itm/230776895665&quot;&gt;http://www.ebay.co.uk/itm/230776895665&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;hacking-the-generic-pir&quot;&gt;Hacking the generic PIR&lt;/h2&gt;

&lt;p&gt;Some time after writing the top half of this post, I got to the testing. Tests on the generic PIR revealed that indeed it was 24v as expected. A simple full wave rectification circuit with four 1N4007 diodes, a couple of capacitors, a signal diode and a couple of resistors.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2015-04-14/generic-pir-surplus-components_0-150x150.jpg&quot; alt=&quot;Components removed from PIR&quot; /&gt;
&lt;img src=&quot;/assets/2015-04-14/2015-04-08-19.23.58-150x150.jpg&quot; alt=&quot;PIR PCB with components removed&quot; /&gt;
&lt;img src=&quot;/assets/2015-04-14/2015-04-08-19.00.48_0-150x150.jpg&quot; alt=&quot;PIR PCB back in housing&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Turns out the signal diode was mostly redundant as far as I can tell, it’s included to eliminate back EMF but that’s actually dealt with by one of the power diodes without need for it. Eh, I put one of the power diodes back in and removed the signal diode.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2015-04-14/2015-04-08-19.38.26_1-255x300.jpg&quot; alt=&quot;PIR PCB standing vertically&quot; /&gt;&lt;/p&gt;

&lt;p&gt;So testing! Lets see what the current consumption is like on this after the modification&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/2015-04-14/generic-pir-current-off-300x138.jpg&quot; alt=&quot;&quot; /&gt;
&lt;img src=&quot;/assets/2015-04-14/generic-pir-current-on-300x140.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Huzzah! 24v DC PIR with low current consumption and low cost. Our terminals are now switched 24v DC, 0v and +24v DC enabling us to use this on an input as suggested above. The input can then be mapped to the sensor input on the lighting controller and programming via the Loxone as documented.&lt;/p&gt;

&lt;p&gt;I’m very happy with this money saving hack and will be buying a few more of these sensors in the very near future!&lt;/p&gt;
</content>
<summary>Is there anybody there? Click once for yes!</summary>
</entry>
</feed>
