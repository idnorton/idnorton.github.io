<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=3e3eef6aaa4dc2ca4725ac2d3d48d5e4eeb8bd8f" media="screen" type="text/css">
    <link rel="stylesheet" href="/assets/css/print.css" media="print" type="text/css">

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->

<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>SSH ProxyCommand for subnets | Ian Norton</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="SSH ProxyCommand for subnets" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="SSH ProxyCommand for subnets" />
<meta property="og:description" content="SSH ProxyCommand for subnets" />
<link rel="canonical" href="http://localhost:4000/2020/03/28/SSH-ProxyCommand-for-subnets.html" />
<meta property="og:url" content="http://localhost:4000/2020/03/28/SSH-ProxyCommand-for-subnets.html" />
<meta property="og:site_name" content="Ian Norton" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-03-28T00:00:00+00:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"http://localhost:4000/2020/03/28/SSH-ProxyCommand-for-subnets.html","headline":"SSH ProxyCommand for subnets","dateModified":"2020-03-28T00:00:00+00:00","datePublished":"2020-03-28T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/03/28/SSH-ProxyCommand-for-subnets.html"},"description":"SSH ProxyCommand for subnets","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>
    <header>
      <div class="inner">
        <a href="http://localhost:4000/">
          <h1>Ian Norton</h1>
        </a>
        <h2>Website and blog</h2>
        
          <a href="https://github.com/idnorton/idnorton.github.io" class="button"><small>View project on</small> GitHub</a>
        
        
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1 id="ssh-proxycommand-for-subnets">SSH ProxyCommand for subnets</h1>

<p>It’s common in modern cloud environments to prevent ssh access to hosts
within the environment and only allow access to a single well maintained
bastion host with suitable protections against attack.</p>

<p>If you have multiple environments with non overlapping IP address
assignments then it would be neat to be able to configure the ssh client
to be able to use a different bastion host based on a CIDR match.</p>

<p>Let’s take some examples:</p>

<table>
  <thead>
    <tr>
      <th>AWS Account</th>
      <th>Bastion host</th>
      <th>CIDR</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Account A</td>
      <td>bastion.account-a.example.com</td>
      <td>10.0.0.0/16</td>
    </tr>
    <tr>
      <td>Account B</td>
      <td>bastion.account-b.example.com</td>
      <td>10.1.0.0/16</td>
    </tr>
    <tr>
      <td>Account C</td>
      <td>bastion.account-c.example.com</td>
      <td>10.2.0.0/24</td>
    </tr>
    <tr>
      <td>Account D</td>
      <td>bastion.account-d.example.com</td>
      <td>10.3.0.0/25</td>
    </tr>
    <tr>
      <td>Account E</td>
      <td>bastion.account-e.example.com</td>
      <td>10.3.0.128/25</td>
    </tr>
  </tbody>
</table>

<p>In the table above, we can use a traditional string match for the first
three:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Match 10.0.*
    ProxyCommand ssh -q bastion.account-a.example.com -W %h:%p

Match 10.1.*
    ProxyCommand ssh -q bastion.account-b.example.com -W %h:%p

Match 10.2.*
    ProxyCommand ssh -q bastion.account-c.example.com -W %h:%p
</code></pre></div></div>

<p>However that doesn’t work for the last two. So how do we do this?
The answer is that we cannot achieve this with the a standard
configuration options.</p>

<p>This is something that’s had questions online <a href="https://serverfault.com/questions/803902/">https://serverfault.com/questions/803902/</a></p>

<p>There’s even a feature request <a href="http://bugzilla.mindrot.org/show_bug.cgi?id=1169">http://bugzilla.mindrot.org/show_bug.cgi?id=1169</a></p>

<p>There isn’t currently a way to do this, however there is a neat feature in
<code class="language-plaintext highlighter-rouge">Match exec</code> which allows us to run a command and use the exit codes:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The exec keyword executes the specified command under the user's shell.  If the
command returns a zero exit status then the condition is considered true.
</code></pre></div></div>

<p>Docs at <a href="https://linux.die.net/man/5/ssh_config">https://linux.die.net/man/5/ssh_config</a></p>

<p>Having written some GoLang to do the network matching, we can now use this syntax:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Match exec "~/bin/ssh-test-network --cidr=10.3.0.0/25 --host=%n
    ProxyCommand ssh -q bastion.account-d.example.com -W %h:%p

  Match exec "~/bin/ssh-test-network --cidr=10.3.0.128/25 --host=%n
    ProxyCommand ssh -q bastion.account-e.example.com -W %h:%p
</code></pre></div></div>

<p>Here’s the command line options for the tool:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./ssh-test-network --help
Usage of ./ssh-test-network:

  -cidr string
        CIDR network to test against
  -debug
        Enable debugging
  -host string
        Hostname to test

Use this command to route subnet ssh via a jumphost in your ssh config:

  Match exec "~/bin/ssh-test-network --cidr=10.0.0.0/8 --host=%n
    ProxyCommand ssh -q jumpbox.example.com -W %h:%p
    ForwardAgent yes
</code></pre></div></div>

<h1 id="files">Files</h1>

<ul>
  <li><a href="/assets/2020-03-28/ssh-test-network">ssh-test-network (binary)</a></li>
  <li><a href="/assets/2020-03-28/ssh-test-network.go">ssh-test-network.go (source)</a></li>
</ul>

        </section>

        <aside id="sidebar">
          

          
            <p class="repo-owner"><a href="https://github.com/idnorton/idnorton.github.io">idnorton.github.io</a> is maintained by <a href="https://github.com/idnorton">idnorton</a>.</p>
          

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</p>
        </aside>
      </div>
    </div>

    
  </body>
</html>
